import os
import numpy as np
import matplotlib.pyplot as plt

# Scatter plot to compare Q times
def make_scatter_plot(xarr_1,xarr_2,yarr_1_lst,yarr_2_lst,log=False,xaxis_name="x",yaxis_name="y",tag1="set1",tag2="set2",save_name="test",nevents=None):

    #fig, axs = plt.subplots(nrows=1, ncols=1)

    # Create the figure
    fig, (ax1, ax2, ax3) = plt.subplots(
        nrows=3,
        ncols=1,
        figsize=(7,7),
        gridspec_kw={"height_ratios": (1, 1, 1)},
        sharex=True
    )
    fig.subplots_adjust(hspace=.09)

    # Loop over the sets of events and plot them
    if len(yarr_1_lst) != len(yarr_2_lst): raise Exception("Number of sets of points to plot do not agree between cpu and gpu")
    for i in range(len(yarr_1_lst)):
        print(f"Plotting for set {i}...")
        # Plot the data on main plot
        if i==0:
            ax1.scatter(xarr_1,yarr_1_lst[i],color="orange",edgecolors='orange',facecolors="none",label=tag1,zorder=100)
            ax1.scatter(xarr_2,yarr_2_lst[i],color="blue",edgecolors='blue',facecolors="none",label=tag2,zorder=100)
        else:
            ax1.scatter(xarr_1,yarr_1_lst[i],color="orange",edgecolors='orange',facecolors="none",zorder=100)
            ax1.scatter(xarr_2,yarr_2_lst[i],color="blue",edgecolors='blue',facecolors="none",zorder=100)

        # Plot events/s in kHz
        ax2.scatter(xarr_1,nevents/(1000*yarr_1_lst[i]),color="orange",edgecolors='orange',facecolors="none",zorder=100)
        ax2.scatter(xarr_2,nevents/(1000*yarr_2_lst[i]),color="blue",edgecolors='blue',facecolors="none",zorder=100)

        # Plot the ratio on the ratio plot
        min_len_x = min(len(xarr_1),len(xarr_2))
        r_arr = yarr_1_lst[i][:min_len_x]/yarr_2_lst[i][:min_len_x]
        ax3.scatter(xarr_1[:min_len_x],r_arr,color="orange",edgecolors='orange',facecolors="none",zorder=100)

    # Set log scale
    if log:
        ax1.set_yscale('log')
        ax2.set_yscale('log')
        save_name = save_name+"_log"

    # Set titles and such
    ax1.set_ylabel(yaxis_name)
    ax2.set_ylabel(f"Events/s [kHz]")
    ax1.legend(fontsize="12",framealpha=1)
    ax1.set_title(save_name)
    ax1.grid(zorder=-99)
    ax2.grid(zorder=-99)
    ax3.grid(zorder=-99)
    ax3.axhline(1.0,linestyle="-",color="k",linewidth=1)
    ax3.set_ylabel(f"{tag1}/{tag2}")
    ax3.set_xlabel(xaxis_name)

    #ax1.set_ylim(0.1,10e4)
    #ax2.set_ylim(1,10e5)
    #ax3.set_ylim(-100,1050)

    #ax3.yaxis.set_major_locator(5)
    #plt.yticks(5)
    plt.locator_params(axis="y", nbins=5) 


    plt.savefig(os.path.join(f"plots/{save_name}.png"),format="png")
    plt.savefig(os.path.join(f"plots/{save_name}.pdf"),format="pdf")
    #plt.show()
    return plt



def main():


    # Dict to keep track of the order of the dt time values printed in the timing array
    # The structure of the np array is like:
    # np.array([
    #    [read,load,fill,total times for query 1],
    #    [read,load,fill,total times for query 2], 
    #    ...
    # ]
    time_lables_dict = {
        0 : "read",
        1 : "load",
        2 : "compute",
        3 : "fill",
        4 : "total",
    }

    # Queries (for x axis)
    x_gpu = [1,2,3,4,5,6,7]
    x_cpu = [1,2,3,4,5,6,7,8]

    # Timing numbers
    timing_dict = {

        # Run 100k, about 3m
        "100k" : {
            "nevents" : 100000,
            "y_gpu_arr" : np.array([
                # Example
                [[2.144270420074463, 0.0052378177642822266, 1.9073486328125e-06, 0.09120798110961914, 2.240718126296997], [0.02709674835205078, 0.0020318031311035156, 1.430511474609375e-06, 0.0037124156951904297, 0.032842397689819336], [0.023229360580444336, 0.0006740093231201172, 3.509768486022949, 0.001636505126953125, 3.535308361053467], [0.022994518280029297, 0.0005764961242675781, 0.008098840713500977, 0.0008261203765869141, 0.032495975494384766], [0.013553380966186523, 0.0013649463653564453, 2.219862461090088, 0.0008931159973144531, 2.2356739044189453], [0.020303726196289062, 0.0013508796691894531, 0.33686280250549316, 0.0008966922760009766, 0.35941410064697266], [0.025888442993164062, 0.003199338912963867, 0.1412034034729004, 0.0012288093566894531, 0.17151999473571777]],
            ]),
            "y_cpu_arr" : np.array([
                # Example
                [[0.00448298454284668, 0.0005655288696289062, 0.0, 0.0009770393371582031, 0.006025552749633789], [0.007097482681274414, 0.0003719329833984375, 4.76837158203125e-07, 0.0015561580657958984, 0.009026050567626953], [0.011201858520507812, 0.0005850791931152344, 0.00941157341003418, 0.0005500316619873047, 0.02174854278564453], [0.006860971450805664, 0.0004546642303466797, 0.003831148147583008, 0.00032639503479003906, 0.01147317886352539], [0.009485483169555664, 0.001073598861694336, 0.02265453338623047, 0.0003077983856201172, 0.033521413803100586], [0.02029132843017578, 0.0012133121490478516, 0.3332183361053467, 0.0009164810180664062, 0.3556394577026367], [0.02793097496032715, 0.0024673938751220703, 0.0631263256072998, 0.0006544589996337891, 0.09417915344238281], [0.014684438705444336, 0.0017819404602050781, 0.06895589828491211, 0.00032782554626464844, 0.08575010299682617]]
            ]),
        },

        "1M" : {
            "nevents" : 1e6,
            "y_gpu_arr" : np.array([
                # Oct 2025: Not first run in the session
                #[[1.8438389301300049, 0.004712343215942383, 1.430511474609375e-06, 0.08623623847961426, 1.9347889423370361], [0.30137109756469727, 0.002364635467529297, 1.6689300537109375e-06, 0.00744938850402832, 0.3111867904663086], [0.052358388900756836, 0.0013396739959716797, 3.4561960697174072, 0.003908634185791016, 3.5138027667999268], [0.03137350082397461, 0.0008075237274169922, 0.010743856430053711, 0.0011014938354492188, 0.04402637481689453], [0.24562788009643555, 0.0025300979614257812, 20.996439933776855, 0.0009207725524902344, 21.245518684387207], [0.07942509651184082, 0.0024271011352539062, 23.552386045455933, 0.05056905746459961, 23.684807300567627], [0.28714776039123535, 0.005764961242675781, 0.4032607078552246, 0.002384185791015625, 0.6985576152801514]],
                #[[1.65358304977417, 0.0034482479095458984, 1.9073486328125e-06, 0.07635354995727539, 1.733386754989624], [0.04059100151062012, 0.0016963481903076172, 1.6689300537109375e-06, 0.006937265396118164, 0.04922628402709961], [0.03651714324951172, 0.0011892318725585938, 3.3982155323028564, 0.0038988590240478516, 3.4398207664489746], [0.03146958351135254, 0.0008134841918945312, 0.008628606796264648, 0.0011048316955566406, 0.04201650619506836], [0.0698709487915039, 0.002220630645751953, 21.262521743774414, 0.0009050369262695312, 21.33551836013794], [0.07564496994018555, 0.0024361610412597656, 23.631060361862183, 0.050608158111572266, 23.7597496509552], [0.1477518081665039, 0.030122041702270508, 0.3798856735229492, 0.002435445785522461, 0.5601949691772461]],
                #[[1.5721306800842285, 0.0018508434295654297, 1.6689300537109375e-06, 0.06838822364807129, 1.642371416091919], [0.04028677940368652, 0.0016465187072753906, 1.6689300537109375e-06, 0.006931304931640625, 0.04886627197265625], [0.036428213119506836, 0.001088857650756836, 3.379329204559326, 0.0038361549377441406, 3.420682430267334], [0.031404972076416016, 0.0008323192596435547, 0.008663654327392578, 0.0011115074157714844, 0.04201245307922363], [0.07005476951599121, 0.0022666454315185547, 20.928296327590942, 0.000888824462890625, 21.001506567001343], [0.07555794715881348, 0.0026099681854248047, 23.434308290481567, 0.05063962936401367, 23.56311583518982], [0.14769792556762695, 0.03016376495361328, 0.3757970333099365, 0.0023789405822753906, 0.5560376644134521]],
                #[[1.6719496250152588, 0.004891157150268555, 1.430511474609375e-06, 14.391260862350464, 16.068103075027466], [0.040779829025268555, 0.002293109893798828, 1.9073486328125e-06, 0.007574796676635742, 0.05064964294433594], [0.037157535552978516, 0.0010986328125, 7.0826146602630615, 0.0040264129638671875, 7.124897241592407], [0.031304359436035156, 0.0008151531219482422, 0.010962724685668945, 0.0010912418365478516, 0.044173479080200195], [0.06985330581665039, 0.0023174285888671875, 21.210305213928223, 0.0009377002716064453, 21.283413648605347], [0.0763087272644043, 0.002468585968017578, 23.681931018829346, 0.05060434341430664, 23.811312675476074], [0.14772462844848633, 0.013870954513549805, 1.3408823013305664, 0.0024437904357910156, 1.5049216747283936]],
            ]),
            "y_cpu_arr" : np.array([
                # Oct 2025: Not first run in the session
                #[[0.008423328399658203, 0.01165461540222168, 4.76837158203125e-07, 0.004821300506591797, 0.024899721145629883], [0.04226398468017578, 0.4848017692565918, 2.384185791015625e-07, 0.015774965286254883, 0.5428409576416016], [0.0798482894897461, 0.9398617744445801, 0.10939717292785645, 0.0032720565795898438, 1.1323792934417725], [0.04354691505432129, 0.4469723701477051, 0.034151315689086914, 0.0008814334869384766, 0.5255520343780518], [0.06508803367614746, 0.8205957412719727, 0.14017200469970703, 0.0006527900695800781, 1.0265085697174072], [0.19626069068908691, 2.2905116081237793, 8.424591064453125, 0.0063707828521728516, 10.917734146118164], [0.233245849609375, 2.8491427898406982, 0.8442635536193848, 0.004139423370361328, 3.9307916164398193], [0.14404058456420898, 0.910529375076294, 0.5769891738891602, 0.0007419586181640625, 1.6323010921478271]],
                #[[0.008526086807250977, 0.011503458023071289, 2.384185791015625e-07, 0.004793405532836914, 0.02482318878173828], [0.04246926307678223, 0.4736311435699463, 4.76837158203125e-07, 0.01682758331298828, 0.532928466796875], [0.08041214942932129, 0.9211568832397461, 0.1107945442199707, 0.0032308101654052734, 1.1155943870544434], [0.04365277290344238, 0.44280266761779785, 0.0329439640045166, 0.0008420944213867188, 0.5202414989471436], [0.0654134750366211, 0.8018980026245117, 0.13703441619873047, 0.0006554126739501953, 1.0050013065338135], [0.19711995124816895, 2.2704994678497314, 7.8084635734558105, 0.006009817123413086, 10.282092809677124], [0.23181581497192383, 2.7842724323272705, 0.8262193202972412, 0.004186868667602539, 3.846494436264038], [0.10234212875366211, 0.9417541027069092, 0.5820846557617188, 0.0006968975067138672, 1.626877784729004]],
                #[[0.008370399475097656, 0.010797739028930664, 4.76837158203125e-07, 0.004731416702270508, 0.02390003204345703], [0.04276108741760254, 0.482830286026001, 4.76837158203125e-07, 0.015757083892822266, 0.541348934173584], [0.07880949974060059, 0.9424989223480225, 0.11024117469787598, 0.003200054168701172, 1.1347496509552002], [0.04351377487182617, 0.4546802043914795, 0.03407025337219238, 0.0008711814880371094, 0.5331354141235352], [0.06483030319213867, 0.8071448802947998, 0.13172698020935059, 0.0006358623504638672, 1.004338026046753], [0.19876885414123535, 2.321704864501953, 8.374224185943604, 0.006059408187866211, 10.900757312774658], [0.2275686264038086, 2.8018195629119873, 0.8318209648132324, 0.004132747650146484, 3.865341901779175], [0.10260939598083496, 0.9584133625030518, 0.5809645652770996, 0.0006804466247558594, 1.6426677703857422]],
                #[[0.00815725326538086, 0.011823415756225586, 2.384185791015625e-07, 0.004824399948120117, 0.024805307388305664], [0.0447382926940918, 0.46716761589050293, 7.152557373046875e-07, 0.01609516143798828, 0.5280017852783203], [0.08342766761779785, 0.9147956371307373, 0.14674997329711914, 0.0033690929412841797, 1.1483423709869385], [0.04599142074584961, 0.44071340560913086, 0.03262042999267578, 0.0008518695831298828, 0.5201771259307861], [0.06499624252319336, 0.8060362339019775, 0.16067981719970703, 0.0006346702575683594, 1.0323469638824463], [0.20234203338623047, 2.2491772174835205, 7.926513910293579, 0.006731510162353516, 10.384764671325684], [0.23135662078857422, 2.758131742477417, 0.8085637092590332, 0.004128932952880859, 3.8021810054779053], [0.10287165641784668, 0.9009122848510742, 0.5519974231719971, 0.0006940364837646484, 1.5564754009246826]],
            ]),
        },

        # Takes about 40m to run
        "10M" : {
            "nevents" : 1e6,
            "y_gpu_arr" : np.array([
                # Jul 2025: Not first run in the session (had run on smaller sample first), sync time for GPU, pyarrow for cpu
                #[[1.5815753936767578, 0.00156402587890625, 0.07590317726135254, 1.6590425968170166], [0.07701683044433594, 0.0016074180603027344, 0.038376569747924805, 0.11700081825256348], [0.09454607963562012, 0.0021135807037353516, 3.0548038482666016, 3.151463508605957], [0.07436060905456543, 0.001234292984008789, 0.03155684471130371, 0.10715174674987793], [0.13285064697265625, 0.005905628204345703, 1.1622741222381592, 1.3010303974151611]],
                #[[1.6861388683319092, 0.0018656253814697266, 0.07868528366088867, 1.7666897773742676], [0.07832741737365723, 0.0018076896667480469, 0.03959178924560547, 0.11972689628601074], [0.09486174583435059, 0.0021278858184814453, 3.0948309898376465, 3.1918206214904785], [0.07574081420898438, 0.001272439956665039, 0.0317685604095459, 0.10878181457519531], [0.12839722633361816, 0.005967378616333008, 1.1795237064361572, 1.3138883113861084]],
                #[[2.076409101486206, 0.00516200065612793, 4.802795648574829, 6.884366750717163], [0.5489840507507324, 0.002950906753540039, 0.0398101806640625, 0.591745138168335], [0.09500670433044434, 0.0021047592163085938, 5.1707375049591064, 5.267848968505859], [0.07592463493347168, 0.0012633800506591797, 0.0326848030090332, 0.10987281799316406], [0.6212971210479736, 0.005972623825073242, 0.7522389888763428, 1.3795087337493896]],
            ]),
            "y_cpu_arr" : np.array([
                # Jul 2025: Not first run in the session (had run on smaller sample first), sync time for GPU, pyarrow for cpu
                #[[0.04200387001037598, 0.09935307502746582, 0.056989431381225586, 0.19834637641906738], [0.3683950901031494, 4.350168228149414, 0.19568085670471191, 4.914244174957275], [0.6780776977539062, 8.776479244232178, 1.2706658840179443, 10.725222826004028], [0.3434610366821289, 4.401387453079224, 0.39362525939941406, 5.138473749160767], [0.6263217926025391, 8.871382713317871, 1.6156229972839355, 11.113327503204346], [1.7731642723083496, 21.914700508117676, 72.51578760147095, 96.20365238189697], [2.593351364135742, 27.898444890975952, 9.290273666381836, 39.78206992149353], [1.289369821548462, 10.471790552139282, 6.647113084793091, 18.408273458480835]],
                #[[0.041960954666137695, 0.09601473808288574, 0.056436777114868164, 0.1944124698638916], [0.3701472282409668, 4.3522789478302, 0.19462251663208008, 4.917048692703247], [0.6835751533508301, 8.78408932685852, 1.258218765258789, 10.72588324546814], [0.3445723056793213, 4.429948806762695, 0.39241695404052734, 5.166938066482544], [0.6315445899963379, 8.815284013748169, 1.615509033203125, 11.062337636947632], [1.740649700164795, 22.061144590377808, 72.15735483169556, 95.95914912223816], [2.342261552810669, 27.87834119796753, 9.386913537979126, 39.607516288757324], [1.0867652893066406, 10.180213451385498, 6.834189176559448, 18.101167917251587]],
                #[[0.07789087295532227, 0.09351325035095215, 0.057554006576538086, 0.2289581298828125], [0.3616511821746826, 4.343311071395874, 0.18419861793518066, 4.889160871505737], [0.6643061637878418, 8.726859331130981, 1.2653675079345703, 10.656533002853394], [0.3326690196990967, 4.400164842605591, 0.3871748447418213, 5.120008707046509], [0.6314654350280762, 8.807303428649902, 1.657123327255249, 11.095892190933228], [1.7669188976287842, 21.67437195777893, 72.2206289768219, 95.66191983222961], [2.3154752254486084, 27.49279236793518, 9.342978954315186, 39.151246547698975], [1.078124761581421, 10.38680124282837, 6.869341135025024, 18.334267139434814]],
            ]),
        },

        # Never run to full completion on CPU, many hours
        "53M" : {
            "nevents" : 53446198,
            "y_gpu_arr" : np.array([
            ]),
            "y_cpu_arr" : np.array([
            ]),
        },
    }

    # Make the plots
    #cat_to_plot = "10M"
    cat_to_plot = "1M"
    for dt_category_idx,dt_category_label in time_lables_dict.items():
        nevts = timing_dict[cat_to_plot]["nevents"]
        y_gpu = timing_dict[cat_to_plot]["y_gpu_arr"][:,:,dt_category_idx]
        y_cpu = timing_dict[cat_to_plot]["y_cpu_arr"][:,:,dt_category_idx]
        make_scatter_plot(x_cpu,x_gpu,y_cpu,y_gpu,xaxis_name=f"Benchmark Queries ({dt_category_label})",yaxis_name="Runtime [s]", tag1="CPU", tag2="GPU",save_name=f"adl_benchmarks_nEvents{cat_to_plot}_{dt_category_label}",log=False,nevents=nevts)
        make_scatter_plot(x_cpu,x_gpu,y_cpu,y_gpu,xaxis_name=f"Benchmark Queries ({dt_category_label})",yaxis_name="Runtime [s]", tag1="CPU", tag2="GPU",save_name=f"adl_benchmarks_nEvents{cat_to_plot}_{dt_category_label}",log=True,nevents=nevts)


main()




